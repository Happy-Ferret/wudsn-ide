mads 1.9.9 build 23 (22 Jun 14)
Source: C:\Users\D025328\Documents\Eclipse\workspace.jac\com.wudsn.ide.ref\HEX\Atari8\SDX\SDX-Non-Relocated.asm
     1 = 0000			S_ADDIZ  SMB 'S_ADDIZ'
     2 = 0000			INSTALL  SMB 'INSTALL'
     3 = 0000			U_GONOFF SMB 'U_GONOFF'
     4 = 0000			I_GETTD  SMB 'I_GETTD'
     5 = 0000			COMTAB   SMB 'COMTAB'
     6
     7 				* Atari OS
     8 = 0012			RTCLOK   EQU $0012
     9 = 0043			FMSZPG   EQU $0043
    10 = 0080			LOMEM    EQU $0080
    11 = 0224			VVBLKD   EQU $0224
    12 = 0230			SDLSTL   EQU $0230
    13 = 0231			SDLSTH   EQU $0231
    14 = 02B6			INVFLG   EQU $02B6
    15 = 02BE			SHFLOK   EQU $02BE
    16 = D301			PORTB    EQU $D301
    17 = E45C			SETVBLV  EQU $E45C
    18 = E462			XITVBV   EQU $E462
    19
    20 				* Adresy SDX
    21 = 0701			S_VER    EQU $0701
    22 = 07F7			JEXTSW   EQU $07F7
    23
    24  FA FF			         BLK SPARTA $580
    25
    26 0580-05B3> AD 01 07	         LDA S_VER     ;Ustalenie wersji SDX
    27 0583 29 0F		         AND #$0F
    28 0585 09 30		         ORA #$30
    29 0587 8D C3 01		         STA DSDXVER+2 ;revision
    30 058A AD 01 07		         LDA S_VER
    31 058D 4A			         LSR @
    32 058E 4A			         LSR @
    33 058F 4A			         LSR @
    34 0590 4A			         LSR @
    35 0591 09 30		         ORA #$30
    36 0593 8D C1 01		         STA DSDXVER   ;ver no.
    37
    38 				;         LDA PORTB
    39 				;         PHA
    40 				;         AND #$FE
    41 				;         STA PORTB     ;wylaczenie OSa
    42
    43 				;         LDY #$05
    44 				;L05A1    LDA L05CC,Y   ;przepisanie 2 skokow
    45 				;         STA $FFC6,Y
    46 				;         DEY
    47 				;         BPL L05A1
    48 				;         PLA
    49 				;         STA PORTB
    50
    51 0596 AD B2 05		         LDA VTDMAIN
    52 0599 AE B3 05		         LDX VTDMAIN+1
    53 059C 20 00 00		         JSR S_ADDIZ    ;dodanie po resecie
    54
    55 059F A2 0A		         LDX #$0A
    56 05A1 8E B9 02		         STX COUNTVBL
    57 05A4 A9 00		         LDA #$00
    58 05A6 8D B7 02		         STA CLKFAIL
    59 05A9 8D BA 02		         STA ST_ONOFF
    60 05AC CE 00 00		         DEC INSTALL
    61
    62 05AF 4C 0B 00		         JMP PROCPARM
    63
    64 05B2 00 00		VTDMAIN  DTA V(TDMAIN)
    65
    66 				;L05CC    JMP L05E4
    67 				;         JMP L0649
    68
    69 				************************
    70 05B4 FE FF 01 00		         BLK RELOC MAIN   ; $5D2
    71
    72 0000,028F> A9 00		TDMAIN   LDA #$00         ;przy resecie
    73 0002 8D B7 02		         STA CLKFAIL
    74 0005 AC BA 02		         LDY ST_ONOFF
    75 0008 4C 15 00		         JMP CHKONOFF
    76
    77 000B 20 00 00		PROCPARM JSR U_GONOFF     ;C=ON/OFF, U_FAIL
    78 000E A9 00		         LDA #$00
    79 0010 2A			         ROL @            ;zlapanie C
    80 0011 A8			         TAY
    81 0012 8C BA 02		         STY ST_ONOFF
    82
    83 0015 C0 00		CHKONOFF CPY #$00
    84 0017 F0 0B		         BEQ TURNOFF
    85
    86 				* Wlacz TD
    87 0019 AC 6B 00		         LDY PTDVBPRO
    88 001C AE 6C 00		         LDX PTDVBPRO+1
    89 001F 20 66 00		         JSR CHGVBLK
    90 0022 18			         CLC
    91 0023 60			         RTS
    92
    93 				* Wylacz TD
    94 0024 A0 62		TURNOFF  LDY <XITVBV
    95 0026 A2 E4		         LDX >XITVBV
    96 0028 20 66 00		         JSR CHGVBLK
    97
    98 002B AD 30 02		         LDA SDLSTL   ;Przywroc jesli
    99 002E CD 6D 00		         CMP PNEWDL   ;te same adresy
   100 0031 D0 31		         BNE XTURNOFF ;DL
   101 0033 AD 31 02		         LDA SDLSTH
   102 0036 CD 6E 00		         CMP PNEWDL+1
   103 0039 D0 29		         BNE XTURNOFF
   104
   105 003B 38			         SEC          ;Przywrocenie
   106 003C AD B3 01		         LDA ADROLDDL ;starej DL
   107 003F E9 03		         SBC #$03
   108 0041 8D 30 02		         STA SDLSTL
   109 0044 85 43		         STA FMSZPG
   110 0046 AD B4 01		         LDA ADROLDDL+1
   111 0049 E9 00		         SBC #$00
   112 004B 8D 31 02		         STA SDLSTH
   113 004E 85 44		         STA FMSZPG+1
   114
   115 0050 A0 06		         LDY #$06
   116 0052 B1 43		NEXTDLB  LDA (FMSZPG),Y
   117 0054 C8			         INY            ;Szukamy
   118 0055 C9 41		         CMP #$41       ;JMP+VBLK
   119 0057 D0 F9		         BNE NEXTDLB
   120 0059 AD 30 02		         LDA SDLSTL     ;Przepisujemy
   121 005C 91 43		         STA (FMSZPG),Y ;z niego
   122 005E C8			         INY            ;adres
   123 005F AD 31 02		         LDA SDLSTH     ;poczatku DL
   124 0062 91 43		         STA (FMSZPG),Y
   125 0064 18			XTURNOFF CLC
   126 0065 60			         RTS
   127
   128 				* Zmiana wektora VB
   129 0066 A9 07		CHGVBLK  LDA #07       ;VVBLKD
   130 0068 4C 5C E4		         JMP SETVBLV
   131
   132 				;         LDA RTCLOK+2
   133 				;WAITCLK  CMP RTCLOK+2
   134 				;         BEQ WAITCLK
   135 				;         STY VVBLKD
   136 				;         STX VVBLKD+1
   137 				;         RTS
   138
   139 006B 33 02		PTDVBPRO DTA V(TDVBPROC)
   140 006D AC 01		PNEWDL   DTA V(NEWDL)
   141
   142 				************************
   143 006F 2C B7 02		PREPINFO BIT CLKFAIL
   144 0072 10 02		         BPL L0650
   145 0074 38			         SEC
   146 0075 60			         RTS
   147
   148 0076 CE B7 02		L0650    DEC CLKFAIL
   149 0079 8E 9B 01		         STX PUTCHAR+2  ;Zapamietanie adresu
   150 007C 8C 9A 01		         STY PUTCHAR+1  ;info
   151 007F 20 00 00		         JSR I_GETTD
   152 0082 90 04		         BCC TIMEDATE
   153 0084 EE B7 02		         INC CLKFAIL    ;Gdy nie da sie odczytac zegara
   154 0087 60			         RTS
   155
   156 				* Przygotowanie daty i czasu
   157
   158 0088 AD 0F 00		TIMEDATE LDA COMTAB+$0F ;rok
   159 008B 38			         SEC
   160 008C E9 54		         SBC #84
   161 008E B0 02		         BCS SKIPY2K ;Y2K
   162 0090 69 64		         ADC #$64    ;Y2K
   163 0092 8D 9E 00		SKIPY2K  STA YEARIDX+1
   164 0095 48			         PHA         ;Y2K
   165 0096 29 03		         AND #$03    ;Y2K
   166 0098 A8			         TAY         ;Y2K
   167 0099 68			         PLA         ;Y2K
   168 009A 4A			         LSR @
   169 009B 4A			         LSR @
   170 009C 38			         SEC         ;Y2K CLC
   171 009D 69 00		YEARIDX  ADC #$00
   172 009F 6D 0D 00		         ADC COMTAB+$0D ;dzien
   173 00A2 AE 0E 00		         LDX COMTAB+$0E ;mies
   174 00A5 7D 2E 01		         ADC MONTHOFS-1,X
   175
   176 00A8 C0 00		         CPY #$00    ;Y2K
   177 00AA D0 02		         BNE SKIPY2K1        ;Y2K
   178 00AC E0 03		         CPX #$03    ;Y2K
   179 00AE E9 07		SKIPY2K1 SBC #$07    ;Y2K
   180 00B0 B0 FC		         BCS SKIPY2K1 ;Y2K
   181 00B2 69 08		         ADC #$08    ;Y2K
   182
   183 				         ;Y2K TAY
   184 				         ;Y2K LDA COMTAB+$0F
   185 				         ;Y2K AND #$03
   186 				         ;Y2K BNE L0685
   187 				         ;Y2K CPX #$03
   188 				         ;Y2K BCC L0686
   189 				;Y2K L0685    INY
   190 				;Y2K L0686    TYA
   191 				;Y2K L0687    CMP #$07
   192 				;Y2K          BCC L068F
   193 				;Y2K          SBC #$07
   194 				;Y2K          BCS L0687
   195 				;Y2K L068F    ADC #$02  ;i mamy w A numer dnia tygodnia
   196 00B4 48			         PHA
   197
   198 00B5 A0 00		         LDY #$00  ;Zaczynamy drukowanie od poz.0
   199
   200 00B7 20 9E 01		         JSR PRNSEP
   201 00BA AD BE 02		         LDA SHFLOK
   202 00BD F0 03		         BEQ SMALL
   203 00BF A9 41		         LDA #'A'
   204 00C1 2C			         DTA B($2C)
   205 00C2 A9 61		SMALL    LDA #'a'
   206 00C4 AE B6 02		         LDX INVFLG
   207 00C7 F0 02		         BEQ NORMAL
   208 00C9 09 80		         ORA #$80     ;zrob inverse
   209 00CB 20 99 01		NORMAL   JSR PUTCHAR
   210 00CE 20 9E 01		         JSR PRNSEP
   211
   212 00D1 68			         PLA       ;W A nr dnia tygodnia
   213 00D2 AA			         TAX
   214 00D3 BD 3A 01		         LDA DAY1-1,X
   215 00D6 20 99 01		         JSR PUTCHAR
   216 00D9 BD 41 01		         LDA DAY2-1,X
   217 00DC 20 99 01		         JSR PUTCHAR
   218 00DF BD 48 01		         LDA DAY3-1,X
   219 00E2 20 99 01		         JSR PUTCHAR
   220 00E5 20 A1 01		         JSR PRNSPACE
   221 00E8 AD 0D 00		         LDA COMTAB+$D ;dzien
   222 00EB 20 77 01		         JSR L075C
   223 00EE 20 A7 01		         JSR PRNMINUS
   224 00F1 AE 0E 00		         LDX COMTAB+$E ;mies
   225 00F4 BD 4F 01		         LDA MONTH1-1,X
   226 00F7 20 99 01		         JSR PUTCHAR
   227 00FA BD 5B 01		         LDA MONTH2-1,X
   228 00FD 20 99 01		         JSR PUTCHAR
   229 0100 BD 67 01		         LDA MONTH3-1,X
   230 0103 20 99 01		         JSR PUTCHAR
   231 0106 20 A7 01		         JSR PRNMINUS
   232 0109 AD 0F 00		         LDA COMTAB+$F ;rok
   233 010C 20 74 01		         JSR L0759
   234
   235 010F 20 9E 01		         JSR PRNSEP
   236 0112 AD 10 00		         LDA COMTAB+$10 ;hh
   237 0115 20 77 01		         JSR L075C
   238 0118 20 A4 01		         JSR PRNCOLON
   239 011B AD 11 00		         LDA COMTAB+$11 ;mm
   240 011E 20 74 01		         JSR L0759
   241 0121 20 A4 01		         JSR PRNCOLON
   242 0124 AD 12 00		         LDA COMTAB+$12 ;ss
   243 0127 20 74 01		         JSR L0759
   244
   245 012A 18			         CLC
   246 012B EE B7 02		         INC CLKFAIL
   247 012E 60			         RTS
   248
   249 012F 00 03 03 06 01 04	MONTHOFS DTA B($00,$03,$03,$06,$01,$04)
   250 0135 06 02 05 00 03 05	         DTA B($06,$02,$05,$00,$03,$05)
   251
   252 				* Polskie
   253 				;DAY1     DTA C'SNPWSCP'
   254 				;DAY2     DTA C'oiotrzi'
   255 				;DAY3     DTA C'benoowa'
   256 				;MONTH1   DTA C'SLMKMCLSWPLG'
   257 				;MONTH2   DTA C'tuawaziirair'
   258 				;MONTH3   DTA C'ytrijepezzsu'
   259
   260 				* Angielskie
   261 013B 53 53 4D 54 57 54 + DAY1     DTA C'SSMTWTF'
   262 0142 61 75 6F 75 65 68 + DAY2     DTA C'auouehr'
   263 0149 79 6E 6E 65 64 75 + DAY3     DTA C'ynnedui'
   264 0150 4A 46 4D 41 4D 4A + MONTH1   DTA C'JFMAMJJASOND'
   265 015C 61 65 61 70 61 75 + MONTH2   DTA C'aeapauuuecoe'
   266 0168 6E 62 72 72 79 6E + MONTH3   DTA C'nbrrynlgptvc'
   267
   268 0174 A2 FF		L0759    LDX #$FF
   269 0176 2C			         DTA B($2C) ; Bit
   270 0177 A2 00		L075C    LDX #$00
   271 0179 8E B8 02		L075E    STX STORAGE+$29
   272 017C A2 FF		         LDX #$FF
   273 017E 38			         SEC
   274 017F E8			L0764    INX
   275 0180 E9 0A		         SBC #$0A
   276 0182 B0 FB		         BCS L0764
   277 0184 69 0A		         ADC #$0A
   278 0186 48			         PHA
   279 0187 8A			         TXA
   280 0188 D0 07		         BNE L0776
   281 018A 2C B8 02		         BIT STORAGE+$29
   282 018D 30 02		         BMI L0776
   283 018F 09 10		         ORA #$10
   284 0191 20 97 01		L0776    JSR L077C
   285 0194 68			         PLA
   286 0195 29 0F		         AND #$0F
   287 0197 49 30		L077C    EOR #$30
   288 0199 99 FF FF		PUTCHAR  STA $FFFF,Y
   289 019C C8			         INY
   290 019D 60			         RTS
   291
   292 019E A9 7C		PRNSEP   LDA #'|'
   293 01A0 2C			         DTA B($2C)
   294 01A1 A9 20		PRNSPACE LDA #' '
   295 01A3 2C			         DTA B($2C)
   296 01A4 A9 3A		PRNCOLON LDA #':'
   297 01A6 2C			         DTA B($2C)
   298 01A7 A9 2D		PRNMINUS LDA #'-'
   299 01A9 18			L078B    CLC
   300 01AA 90 ED		         BCC PUTCHAR
   301
   302 01AC 70 70		NEWDL    DTA B($70,$70)
   303 01AE 30 42		         DTA B($30,$42)
   304 01B0 8F 02		         DTA V(STORAGE)
   305 01B2 01			         DTA B($01)
   306 01B3 00 00		ADROLDDL DTA V($0000)
   307
   308 01B5 53 70 61 72 74 61 + TDLINE   DTA C'SpartaDOS X '
   309 01C1 34 2E 32		DSDXVER  DTA C'4.2'
   310 01C4 00 00 00 00		TDLINFO  DTA B($00,$00,$00,$00)
   311 01C8 00 00 00 00		         DTA B($00,$00,$00,$00)
   312 01CC 00 00 00 00		         DTA B($00,$00,$00,$00)
   313 01D0 00 00 00 00		         DTA B($00,$00,$00,$00)
   314 01D4 00 00 00 00		         DTA B($00,$00,$00,$00)
   315 01D8 00 00 00 00		         DTA B($00,$00,$00,$00)
   316 01DC 00 00		         DTA B($00,$00)
   317
   318 01DE C4 01		PTDLINFO DTA V(TDLINFO)
   319
   320 				* Co 30 VBLK
   321 01E0 AD 01 D3		DOTDLINE LDA PORTB
   322 01E3 48			         PHA
   323 01E4 AD EA FF		         LDA COMTAB-$16 ;Indeks banku pamieci EXT
   324 01E7 20 F7 07		         JSR JEXTSW     ;Przelaczenie na niego
   325
   326 01EA AE DF 01		         LDX PTDLINFO+1
   327 01ED AC DE 01		         LDY PTDLINFO
   328 01F0 20 6F 00		         JSR PREPINFO
   329
   330 01F3 A2 00		         LDX #$00
   331 01F5 A9 0F		         LDA #$0F
   332 01F7 A0 00		         LDY #$00
   333 01F9 20 0D 02		         JSR MOV2STOR
   334 01FC A9 19		         LDA #$19
   335 01FE A0 0F		         LDY #$0F
   336 0200 20 0D 02		         JSR MOV2STOR
   337 				;         LDA #$80
   338 				;         STA STORAGE+$27
   339 0203 68			         PLA
   340 0204 8D 01 D3		         STA PORTB    ;Przywrocenie ustawienia pamieci
   341 0207 60			         RTS
   342
   343 0208 C9 80		CHKINV   CMP #$80
   344 020A 90 14		         BCC L07FD  ;mala!
   345
   346 020C 00			TMPCHAR  DTA B(0)
   347
   348 				* Przepisanie bajtow do STORAGE + zmiana kodow
   349 020D 48			MOV2STOR PHA
   350 020E B9 B5 01		         LDA TDLINE,Y
   351 0211 8D 0C 02		         STA TMPCHAR
   352 0214 29 7F		         AND #$7F
   353 0216 C9 60		         CMP #$60
   354 0218 B0 06		         BCS L07FD   ;mala litera?
   355 021A E9 1F		L07F7    SBC #$1F
   356 021C B0 02		         BCS L07FD
   357 021E 69 60		         ADC #$60
   358 0220 2C 0C 02		L07FD    BIT TMPCHAR
   359 0223 30 02		         BMI CHSCREEN
   360 0225 09 80		         ORA #$80    ;ustaw inv.
   361 0227 9D 8F 02		CHSCREEN STA STORAGE,X
   362 022A C8			         INY
   363 022B E8			         INX
   364 022C 68			         PLA
   365 022D 38			         SEC
   366 022E E9 01		         SBC #$01
   367 0230 D0 DB		         BNE MOV2STOR
   368 0232 60			         RTS
   369
   370 0233 D8			TDVBPROC CLD
   371 0234 CE B9 02		         DEC COUNTVBL
   372 0237 D0 53		         BNE XTDVBPRO  ;Czy licznik sie wyzerowal
   373
   374 0239 A9 19		         LDA #25 ;30       ;Licznik od nowa
   375 023B 8D B9 02		         STA COUNTVBL
   376
   377 023E 20 E0 01		         JSR DOTDLINE
   378
   379 0241 AD 30 02		         LDA SDLSTL    ;Czy zmieniono DL ?
   380 0244 CD 6D 00		         CMP PNEWDL
   381 0247 D0 08		         BNE DLCHANGE
   382 0249 AD 31 02		         LDA SDLSTH
   383 024C CD 6E 00		         CMP PNEWDL+1
   384 024F F0 3B		         BEQ XTDVBPRO
   385
   386 0251 A5 80		DLCHANGE LDA LOMEM     ;To gdy zmieniono DL
   387 0253 48			         PHA           ;Zapamietanie LOMEM
   388 0254 A5 81		         LDA LOMEM+1   ;(bedzie uzywane jako TMP)
   389 0256 48			         PHA
   390
   391 0257 AD 30 02		         LDA SDLSTL    ;Przygotowanie DL
   392 025A 85 80		         STA LOMEM
   393 025C 18			         CLC
   394 025D 69 03		         ADC #$03
   395 025F 8D B3 01		         STA ADROLDDL  ;Zmiana adresu skoku
   396 0262 AD 31 02		         LDA SDLSTH    ;na nowa DL
   397 0265 85 81		         STA LOMEM+1
   398 0267 69 00		         ADC #$00
   399 0269 8D B4 01		         STA ADROLDDL+1
   400
   401 026C A0 06		         LDY #$06
   402 026E B1 80		NEWDLBYT LDA (LOMEM),Y
   403 0270 C8			         INY           ;Szukamy
   404 0271 C9 41		         CMP #$41      ;JMP+VBLK w Y
   405 0273 D0 F9		         BNE NEWDLBYT
   406
   407 0275 AD 6D 00		         LDA PNEWDL    ;i przepisujemy adres naszej DL
   408 0278 8D 30 02		         STA SDLSTL    ;do rejestru
   409 027B 91 80		         STA (LOMEM),Y ;i do skoku
   410 027D C8			         INY
   411 027E AD 6E 00		         LDA PNEWDL+1
   412 0281 8D 31 02		         STA SDLSTH
   413 0284 91 80		         STA (LOMEM),Y
   414
   415 0286 68			         PLA           ;Przywracamy poprzednie MEMLO
   416 0287 85 81		         STA LOMEM+1
   417 0289 68			         PLA
   418 028A 85 80		         STA LOMEM
   419 028C 4C 62 E4		XTDVBPRO JMP XITVBV
   420
   421 				************************
   422
   423 028F FE FF 02 80 8F 02 +          BLK EMPTY $2C MAIN ; Num:2 Mem:$80
   424 = 028F			STORAGE  EQU *-$2C
   425 = 02B7			CLKFAIL  EQU STORAGE+$28    ; licznik blednych odczytow zegara
   426 = 02B9			COUNTVBL EQU STORAGE+$2A    ; licznik przerwan VBLK
   427 = 02BA			ST_ONOFF EQU STORAGE+$2B    ; stan ON/OFF
   428
   429 02BB FD FF 02 00 00	         BLK UPDATE ADDRESS
   429 02BB FD A2 05		
   429 02BB FD A7 05		
   429 02BB FD AA 05		
   429 02BB FE 01 03 03 0D 5D + 
   429 02BB FC			
   429 02BB FD FF 01 00 00	
   429 02BB FD 88 05		
   429 02BB FD 94 05		
   429 02BB FD B0 05		
   429 02BB FD B2 05		
   429 02BB FE 01 09 11 03 03 + 
   429 02BB FC			
   430 02BB			         BLK UPDATE SYMBOLS
   430 02BB FB FF 53 5F 41 44 + S_ADDIZ 
   430 02BB FD 9D 05		
   430 02BB FC			
   430 02BB FB FF 49 4E 53 54 + INSTALL 
   430 02BB FD AD 05		
   430 02BB FC			
   430 02BB FB FF 55 5F 47 4F + U_GONOFF
   430 02BB FE 01 0C		
   430 02BB FC			
   430 02BB FB FF 49 5F 47 45 + I_GETTD 
   430 02BB FE 01 80		
   430 02BB FC			
   430 02BB FB FF 43 4F 4D 54 + COMTAB  
   430 02BB FE 01 89 17 03 46 + 
   430 02BB FC			
   431 02BB			         BLK UPDATE NEW PROCPARM '@TD2'
   431 02BB FC FF 01 0B 00	
   431 02BB 40 54 44 32 20 20 + @TD2    
   432 02BB			         BLK UPDATE NEW PREPINFO 'I_FMTTD'
   432 02BB FC FF 01 6F 00	
   432 02BB 49 5F 46 4D 54 54 + I_FMTTD 
   433
   434 				         END
